#!/bin/bash
#
# File: reprepro-backend-krb - Kerberos wrapper for reprepro-backend
#
# Author: Bill MacAllister <bill@ca-zephyr.org>
# Copyright: 2023-2026 Bill MacAllister

# Read the configuration file
if [ -e /etc/cz-reprepro.conf ]
then
    source /etc/cz-reprepro.conf
fi

# Set environment for remctl execution
export HOME=/var/lib/reprepro
export GPG_TTY=

# Setup Kerberos if there is a keytab file
if [ "$KRB_KEYTAB" = "" ]
then
    if [ -e /etc/krb5.keytab ]
    then
        export KRB_KEYTAB=/etc/krb5.keytab
    else
        export KRB_KEYTAB=/NOKEYTABSET
    fi
fi
if [ "$KRB_TGT_FILE" = "" ]
then
    export KRB_TGT_FILE="/tmp/krb5cc_reprepro.tgt"
fi
export KRB5CCNAME="FILE:$KRB_TGT_FILE"

if [ -z "${AFS_AKLOG}" ]
then
    for alogin in /usr/bin/aklog /usr/bin/aklog-kafs
    do
        if [ -e $alogin ]
        then
            export AKLOG=$alogin
            break
        fi
    done
else
    export AKLOG="$AFS_AKLOG"
fi

if [ -z "${AKLOG}" ]
then
    echo "ERROR: aklog or aklog-kafs not found"
    exit 1
else
    echo "Using $AKLOG"
fi
   
# Setup reprepro locations
if [ "$REPREPRO_BASE" = "" ]
then
    REPREPRO_BASE="/afs/cell/public"
fi
if [ "$REPREPRO_REPO" = "" ]
then
    REPREPRO_REPO="repo"
fi
repoPath="$REPREPRO_BASE/$REPREPRO_REPO"

if [ "$REPREPRO_KEYRING" = "" ]
then
    REPREPRO_KEYRING="$repoPath/keyring"
fi
export GNUPGHOME=$REPREPRO_KEYRING

k5start -qtU -f $KRB_KEYTAB -k FILE:/$KRB_TGT_FILE
reprepro-backend $*

exit

__END__

##############################################################################
# Documentation
##############################################################################

=head1 NAME

reprepro-backend-krb - Wrapper reprepro-backend

=head1 SYNOPSIS

reprepro-backend-krb

=head1 DESCRIPTION

This is a trivial script creates a ticket cache, set an AFS token,
and executes reprepre-backend.  This allows reprepro-backend to
be used with repositories that are hosted on AFS volumes.

=head1 LICENSE

Copyright 2023-2026 Bill MacAllister <bill@ca-zephyr.org> These
programs are free software; you may redistribute them and/or modify
them under the same terms as Perl itself.  This means that you may
choose between the two licenses that Perl is released under: the GNU
GPL and the Artistic License.  Please see your Perl distribution for
the details and copies of the licenses.

=head1 AUTHORS

Bill MacAllister <bill@ca-zephyr.org>

=head1 SEE ALSO

reprepro(1), cz-reprepro-upload(1), reprepro-backend(1)

=cut
