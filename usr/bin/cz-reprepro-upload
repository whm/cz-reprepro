#!/bin/bash
#
# File: cz-reprepro-upload - update reprepro managed repository
#
# Author: Bill MacAllister <bill@ca-zephyr.org>
# Copyright: 2015-2022 Bill MacAllister

function display_usage {
    echo "Usage: cz-reprepro-upload help|upload|listkeys"
    exit 1
}

if [ "$REPREPRO_CONF" = "" ]
then
    REPREPRO_CONF="/etc/cz-reprepro-upload.conf"
fi

if [ -e $REPREPRO_CONF ]
then
    source $REPREPRO_CONF
fi

if [ "$REPREPRO_BASE" = "" ]
then
    REPREPRO_BASE="/afs/@cell/public/repo"
fi

if [ "$REPREPRO_KEYRING" = "" ]
then
    REPREPRO_KEYRING="/srv/repos/ca-zephyr/keyring"
fi

if [ "$REPREPRO_REPO" = "" ]
then
    REPREPRO_REPO="ca-zephyr"
fi

repoPath="$REPREPRO_BASE/$REPREPRO_REPO"

case $1 in
    help)
        display_usage
        ;;
    listkeys)
        echo "keyring: $REPREPRO_KEYRING"
        echo "Public keys"
        gpg --homedir=$REPREPRO_KEYRING --list-keys
        echo "Private keys"
        gpg  --homedir=$REPREPRO_KEYRING --list-secret-keys
        ;;
    manual)
        pod2text $0
        ;;
    upload)
        reprepro -b $repoPath --gnupghome=$REPREPRO_KEYRING \
		 processincoming default
        reprepro -b $repoPath --gnupghome=$REPREPRO_KEYRING \
		 pull
	reprepro -b $repoPath --gnupghome=$REPREPRO_KEYRING \
		 export
        ;;
    *)
        echo "ERROR: unknown command $1"
        display_usage
        ;;
esac

exit

__END__

##############################################################################
# Documentation
##############################################################################

=head1 NAME

cz-reprepro-upload - Wrapper around reprepro upload operation

=head1 SYNOPSIS

cz-reprepro-upload upload|listkeys|help|manual

=head1 DESCRIPTION

This is a trivial script that runs the reprepro 'processincoming' and
'pull' commands.  The script is intended to be used either as a remctl
target or as a local execution specified in a .dput.conf configuration
file.

The script will source the file the configuration file if it exists.
The environment variable REPREPRO_CONF can be used to override the
location of the configuration file.  The default for REPREPRO_CONF is
"/etc/cz-reprepro-upload.conf".

=head1 COMMANDS

=over 4

=item upload [<distribution name>]

Execute the command the reprepro commands 'processincoming' and 'pull'
on the specified repository.

=item listkeys

List the repository keys on the server.
that we support.

=item help

Display a brief help message.

=item manual

Display this text.

=back

=head1 EXAMPLES

=head2 Configuration File

        # file: /etc/cz-repreload-upload.conf
        #
        # The base directory of the repository
        REPREPRO_BASE="/afs/@cell/public/repo"
        #
        # The home directory of the keyring for the repository
        REPREPRO_KEYRING="/srv/repos/ca-zephyr/keyring"
        #
        # The name of the repository
        REPREPRO_REPO="ca-zephyr"

=head2 Local Access to the Repository

The following ~/.dput.cf file is an example a updating reprepro
structures using the post processing of dput when the reprepro
distribution is accessible from the local system.

        [cz-afs]
        method = local
        allowed_distributions = ^(stable|testing|unstable)$
        incoming = /afs/@cell/public/repo/ca-zephyr/incoming
        post_upload_command = /usr/bin/cz-reprepro-upload upload ca-zephyr

=head2 SSH/remctl Access to the Repository

        [cz]
        method = scp
        fqdn = shelter-apt.ca-zephyr.internal
        allowed_distributions = ^(unstable|testing|stable)$
        incoming = /srv/repos/ca-zephyr/incoming
        post_upload_command = remctl shelter cz-upload upload

=head2 AFS Access to the Repository
    
Using AFS for repository storage presents the challenge that GPG appears
prevent access to the GPG secret keys.  AFS can still be used to store
the repository, but the GPG keys need to be on local disk and referenced
using the configuration setting REPREPRO_KEYRING.  The dput.cf needs to
specify remctl to perform the upload.

        [cz-afs]
        method = local
        allowed_distributions = ^(stable|testing|unstable)$
        incoming = /afs/@cell/public/repo/ca-zephyr/incoming
        post_upload_command = krenew && remctl shelter-apt cz-upload upload

=head1 LICENSE

Copyright 2015-2022 Bill MacAllister <bill@ca-zephyr.org> These
programs are free software; you may redistribute them and/or modify
them under the same terms as Perl itself.  This means that you may
choose between the two licenses that Perl is released under: the GNU
GPL and the Artistic License.  Please see your Perl distribution for
the details and copies of the licenses.

=head1 AUTHORS

Bill MacAllister <bill@ca-zephyr.org>

=head1 SEE ALSO

reprepro(1), reprepro-upload(1), reprepro-backend(1)

=cut
