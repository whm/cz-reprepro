#!/bin/bash
#
# File: cz-reprepro-upload - update reprepro managed repository
#
# Author: Bill MacAllister <bill@ca-zephyr.org>
# Copyright: 2015-2022 Bill MacAllister

function display_usage {
    echo "Usage: cz-reprepro-upload help|upload|listkeys"
    exit 1
}

if [ -e /etc/cz-reprepro-upload ]
then
    source /etc/cz-reprepro-upload
fi
if [ "$REPREPRO_BASE" = "" ]
then
    REPREPRO_BASE="/afs/@cell/public/repo"
fi
if [ "$2" = "" ]
then
    if [ "$REPREPRO_REPO" = "" ]
    then
        REPREPRO_REPO="ca-zephyr"
    fi
else
    REPREPRO_REPO="$2"
fi

repoPath="$REPREPRO_BASE/$REPREPRO_REPO"

case $1 in
    help)
        display_usage
        ;;
    listkeys)
        GNUPGHOME="$repoPath/keyring"
        export GNUPGHOME
        echo "$GNUPGHOME public keys"
        gpg --list-keys
        echo "$GNUPGHOME secret keys"
        gpg --list-secret-keys
        export GNUPGHOME=""
        ;;
    manual)
        pod2text $0
        ;;
    upload)
        GNUPGHOME="$repoPath/keyring"
        export GNUPGHOME
        reprepro -b $repoPath processincoming default
        reprepro -b $repoPath pull
        export GNUPGHOME=""
        ;;
    *)
        echo "ERROR: unknown command $1"
        display_usage
        ;;
esac

exit

__END__

##############################################################################
# Documentation
##############################################################################

=head1 NAME

cz-reprepro-upload - Wrapper around reprepro upload operation

=head1 SYNOPSIS

cz-reprepro-upload upload|listkeys|help|manual [<distribution name>]

=head1 DESCRIPTION

This is a trivial script that runs the reprepro 'processincoming' and
'pull' commands.  The script is intended to be used either as a remctl
target or as a local execution specified in a .dput.conf configuration
file.

The environment variables REPREPRO_BASE and REPREPRO_REPO can be used
to specify the location of the reprepro installation and the
distribution.  If not specified the defaults are
'/afs/@cell/public/repo' and 'ca-zephyr' respectively.  The script
will source the file /etc/cz-reprepro-upload if it exists.


=head1 COMMANDS

=over 4

=item upload [<distribution name>]

Execute the command the reprepro commands 'processincoming' and 'pull'
on the specified repository.

=item listkeys

List the repository keys on the server.
that we support.

=item help

Display a brief help message.

=item manual

Display this text.

=back

=head1 EXAMPLES

=head2 Local Access to the Repository

The following ~/.dput.cf file is an example a updating reprepro
structures using the post processing of dput when the reprepro
distribution is accessible from the local system.

    [cz-afs]
    method = local
    allowed_distributions = ^(stable|testing|unstable)$
    incoming = /afs/@cell/public/repo/ca-zephyr/incoming
    post_upload_command = /usr/bin/cz-reprepro-upload upload ca-zephyr

=head2 SSH/remctl Access to the Repository

    [cz]
    method = scp
    fqdn = shelter-apt.ca-zephyr.internal
    allowed_distributions = ^(unstable|testing|stable)$
    incoming = /srv/repos/ca-zephyr/incoming
    post_upload_command = remctl shelter-apt.ca-zephyr.internal cz-upload upload ca-zephyr

=head1 LICENSE

Copyright 2015-2022 Bill MacAllister <bill@ca-zephyr.org> These
programs are free software; you may redistribute them and/or modify
them under the same terms as Perl itself.  This means that you may
choose between the two licenses that Perl is released under: the GNU
GPL and the Artistic License.  Please see your Perl distribution for
the details and copies of the licenses.

=head1 AUTHORS

Bill MacAllister <bill@ca-zephyr.org>

=head1 SEE ALSO

reprepro(1), reprepro-upload(1), reprepro-backend(1)

=cut
